name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.4.0)'
        required: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Extract changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Remove 'v' prefix if present for matching changelog headers
          VERSION_NUM="${VERSION#v}"

          # Extract the section for this version from CHANGELOG.md
          # Matches from "## X.Y.Z" until the next "---" separator
          if [ -f "CHANGELOG.md" ]; then
            CHANGELOG=$(awk -v ver="$VERSION_NUM" '
              BEGIN { found=0; output="" }
              /^## / {
                if (found) exit
                if ($2 == ver) found=1
              }
              found && /^---$/ { exit }
              found { output = output $0 "\n" }
              END { print output }
            ' CHANGELOG.md)

            if [ -n "$CHANGELOG" ]; then
              # Use delimiter for multiline output
              echo "changelog<<EOF" >> $GITHUB_OUTPUT
              echo "$CHANGELOG" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "changelog=No changelog entry found for version $VERSION_NUM" >> $GITHUB_OUTPUT
            fi
          else
            echo "changelog=No CHANGELOG.md found" >> $GITHUB_OUTPUT
          fi

      - name: Download SourceMod compiler
        run: |
          mkdir -p .sourcemod
          SM_URL=$(curl -s "https://sm.alliedmods.net/smdrop/1.12/sourcemod-latest-linux" | head -1)
          wget -q "https://sm.alliedmods.net/smdrop/1.12/${SM_URL}" -O sourcemod.tar.gz
          tar -xzf sourcemod.tar.gz -C .sourcemod

      - name: Compile plugin
        run: |
          mkdir -p dist
          cd addons/sourcemod/scripting
          chmod +x ../../../.sourcemod/addons/sourcemod/scripting/spcomp64
          ../../../.sourcemod/addons/sourcemod/scripting/spcomp64 soccer_mod.sp \
            -i"include" \
            -i"../../../.sourcemod/addons/sourcemod/scripting/include" \
            -o"../../../dist/soccer_mod.smx"

      - name: Prepare release package
        run: |
          mkdir -p release

          # === Compiled plugin ===
          mkdir -p release/addons/sourcemod/plugins
          cp dist/soccer_mod.smx release/addons/sourcemod/plugins/

          # === cfg ===
          [ -d "cfg/sm_soccermod" ] && mkdir -p release/cfg && cp -r cfg/sm_soccermod release/cfg/

          # === materials ===
          [ -d "materials" ] && cp -r materials release/

          # === models ===
          [ -d "models" ] && cp -r models release/

          # === sound ===
          [ -d "sound" ] && cp -r sound release/

          # Create release zip
          cd release
          zip -r ../soccer-mod-${{ steps.version.outputs.version }}.zip .

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Soccer Mod ${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
          files: soccer-mod-${{ steps.version.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
